---
title: "Global Biodiversity, Trade, and Conservation Funding"
author: "Evan Daisy, Sanjana Sunder, Kim Zhou"
date: "05/13/2021"
output:
  rmdformats::readthedown:
    thumbnails: false
    highlight: NULL
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.align="center")
library(tidyverse)
library(datasets)
library(viridis)
library(maps)
library(leaflet)
library(ggnetwork)
library(igraph)
library(bslib)
library(rgdal)
library(sqldf)
library(formattable)
library(xtable)
library(kableExtra)
```

## World Maps

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For example, you can include **Bold** and _Italic_ and `Code` text.  For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

You should test out updating your GitHub Pages website:

- clone your group's blog project repo in RStudio
- update "Your Project Title Here" to a new title in the YAML header
- knit `index.Rmd` 
- commit and push BOTH the `index.Rmd` and the `index.html` files
- go to https://stat231-s21.github.io/Blog-Team-Save-the-Planet/ to see the published test document (this is publicly available!)

### Biodiversity
```{r, echo = FALSE}
threatened_iucn <- read.csv("threatenediucn_final.csv")
world_map <- map_data(map = "world"
                      , region = ".")

threatened_all <- threatened_iucn %>%
  group_by(Country) %>%
  summarise(tot_species = sum(num_species)) %>%
  full_join(world_map, by = c("Country" = "region"))

ggplot(data = threatened_all, aes(x = long, y = lat, group = group)) +
      geom_polygon(mapping = aes(x = long, y = lat, fill = tot_species), 
                   colour = "black") +
      theme_void()  +
      coord_fixed(ratio = 1.3) +
      scale_fill_viridis(option = "magma", direction = -1, na.value = "white") +
      labs(title = "Global Species Diversity by IUCN Threat Level"
           , fill = "Number of Species*"
           , caption = "*Regions in white have no data")
```


### International Trade

### Conservation Funding (as of 2013)
```{r, echo = FALSE, message = FALSE, warning = FALSE}
conservation <- read_csv("conservation_final.csv")

# Map of Log(funding)
ggplot(conservation, aes(x = long, y = lat, group = group, 
                         fill = log_funding)) +
  geom_polygon(color = "black") +
  theme_void() +
  coord_fixed(ratio = 1.3) +
  labs(title = "Conservation Funding By Country*"
       , subtitle = "as of 2013"
       , fill = ""
       , caption = "*Regions in white have no data") +
  #scale_fill_continuous(low="thistle2", high="darkred",guide="colorbar", na.value="white")
  scale_fill_viridis(option = "viridis", direction = -1, na.value="white")
```

### Network of Trade between countries


```{r, echo = FALSE}
 # Render the Network of trade between countries
    data <- read.csv("./trade.csv")
    trade_coun <- data %>%
                  select(importer_country, exporter_country) %>%
                  group_by(importer_country, exporter_country) %>%
                  summarize(trade_occurrence = n(), .groups = 'drop') %>%
                  filter(!(is.na(importer_country) | importer_country == "") &
                           !(is.na(exporter_country) | exporter_country == "") ) %>%
                  filter(trade_occurrence >= 200) %>%
                  arrange(desc(trade_occurrence))
    
    net <- graph_from_data_frame(trade_coun, directed = TRUE)
    net_plot <- ggnetwork(net)
    ggplot(data = net_plot
           , aes(x = x, y = y, xend = xend, yend = yend)) +
      geom_edges(curvature = 0.1, arrow=arrow(type="closed", length=unit(8,"pt"))
                 , aes(color = trade_occurrence)) +
      geom_nodes() +
      geom_nodelabel(aes(label = name)) +
      theme_blank() +
      labs(color = "Total Occurrence") +
      scale_color_continuous(type = "viridis")
```

### Count of Species exported by the countries


```{r, , echo = FALSE}
# data vector to extract the total species exported by each country
  exp_country <- data %>%
      select(exporter_country, exporter) %>%
      group_by(exporter, exporter_country) %>%
      summarize(count = n(), .groups = 'drop') %>%
      filter(!(is.na(exporter_country) | exporter_country == "")) %>%
      filter(str_detect(exporter_country, "[a-z]")) 
    
    # Read this shape file with the rgdal library. 
    world_spdf <- readOGR( 
      dsn = paste0(getwd(),"") , 
      layer = "TM_WORLD_BORDERS_SIMPL-0.3",
      verbose = FALSE
    ) 
    # join data frame with shape file
    data_chloro <- world_spdf@data %>%
                    full_join(exp_country, by = c("ISO2" = "exporter"))

    mypalette <- colorBin( palette = "YlOrBr", domain = data_chloro$count
                           , na.color = "transparent", bins = 6)
    mytext <- paste(
      "Country: ", data_chloro$exporter_country,"<br/>", 
      "Count of Species Exported: ", data_chloro$count, "<br/>", 
      "Category: ", "Appendix I", 
      sep = "") %>%
      lapply(htmltools::HTML)
    
    # Basic choropleth with leaflet?
   plot <- leaflet(world_spdf) %>% 
      addTiles()  %>% 
      setView( lat=10, lng=0 , zoom=2) %>%
      addLegend( pal = mypalette, values = ~data_chloro$count
                 , opacity=0.9, title = "Count"
                 , position = "bottomleft" ) %>%
      addPolygons(
        fillColor = ~mypalette(data_chloro$count), 
        layerId = ~data_chloro$exporter_country,
        stroke = FALSE, 
        smoothFactor = 0.5,
        fillOpacity = 0.9, 
        color = "white", 
        weight = 0.3,
        label = mytext,
        labelOptions = labelOptions( 
          style = list("font-weight" = "normal", padding = "3px 8px"), 
          textsize = "13px", 
          direction = "auto"))
   plot
```


## Including links and images

You can include [Links](https://www.datadreaming.org/post/r-markdown-theme-gallery/) and images. ![team logo](https://raw.githubusercontent.com/stat231-s21/Blog-Team-Save-the-Planet/main/images/s1g4-environment.png)

You can embed a gif.

![pugs](https://media.giphy.com/media/XHVmD4RyXgSjd8aUMb/giphy.gif)

# You can even create tabs if you want! {.tabset .tabset-fade .tabset-pills}

## Bulleted list

You can make a bulleted list like this:

- item 1
- item 2
- item 3


## Numbered list

You can make a numbered list like this

1. First thing I want to say
2. Second thing I want to say
3. Third thing I want to say

